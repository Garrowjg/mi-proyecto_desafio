<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reserva de Libros - BookLab Biblioteca</title>
    <link rel="stylesheet" href="/estilos/reserva.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        #mensaje-reserva {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 9999;
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>
<body>

<header>
    <nav>
        <div class="logo">
            <h1>BookLab <span>Biblioteca</span></h1>
        </div>
        <div class="nav-right">
            <ul class="nav-links">
                <li><a href="/api/logiado">Inicio</a></li>
                <li><a href="/api/libroVirtualesLog">Libros virtuales</a></li>
                <li><a href="/api/reservaLibro">Reserva de libros</a></li>
            </ul>
        </div>
    </nav>
</header>

<main class="reserva-section">
    <div class="reserva-container">
        <h2 class="section-title">Reserva tu Libro Favorito</h2>


        <div class="filtros-container">
            <div class="filtro-grupo">
                <label for="categoria">Categoría:</label>
                <select id="categoria" required>
                    <option value="" disabled selected>Selecciona una categoría</option>
                    <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}"></option>
                </select>
            </div>

            <div class="filtro-grupo" id="grupo-busqueda" style="display:none;">
                <label for="busqueda">Buscar libro:</label>
                <input type="text" id="busqueda" placeholder="Título, autor...">
            </div>
        </div>

        <!-- Resultados -->
        <div class="resultados-container" id="resultados-container" style="display:none;">
            <div class="contador-libros">
                <span id="contador">0 libros encontrados</span>
            </div>

            <div class="lista-libros" id="lista-libros">
                <!-- Los libros se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Formulario de reserva -->
        <div class="formulario-reserva" id="formulario-reserva" style="display:none;">
            <h3>Completar Reserva</h3>
            <form id="reserva-form">
                <input type="hidden" id="libro-seleccionado" name="libro">
                <input type="hidden" id="categoria-seleccionada" name="categoria">

                <div class="form-grupo">
                    <label for="idUsuario">ID de Usuario:</label>
                    <input type="text" id="idUsuario" name="idUsuario" required>
                </div>

                <div class="form-grupo">
                    <label for="nombreCompleto">Nombre Completo:</label>
                    <input type="text" id="nombreCompleto" name="nombreCompleto" required>
                </div>

                <div class="form-grupo">
                    <label for="correo">Correo Electrónico:</label>
                    <input type="email" id="correo" name="correo" required>
                </div>

                <div class="form-grupo">
                    <label for="fecha">Fecha de Reserva:</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>

                <div class="form-acciones">
                    <button type="button" id="cancelar-reserva" class="btn btn-secundario">Cancelar</button>
                    <button type="submit" class="btn btn-primario">Confirmar Reserva</button>
                </div>
            </form>
        </div>
    </div>
</main>

<footer>
    <p>&copy; 2024 BookLab Biblioteca. Todos los derechos reservados.</p>
</footer>


<div id="mensaje-reserva"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {

      // Variables para almacenar todos los libros y los que coincidan con la búsqueda
      let todosLosLibros = [];
      let librosFiltrados = [];

      // Cuando el usuario cambia la categoría seleccionada
      $('#categoria').change(function() {
        const categoria = $(this).val(); // Obtiene la categoría seleccionada

        if (categoria) {
          cargarLibros(categoria);       // Carga los libros de esa categoría
          $('#grupo-busqueda').show();   // Muestra el campo de búsqueda
        } else {
          $('#resultados-container').hide(); // Oculta resultados si no se eligió nada
          $('#grupo-busqueda').hide();       // Oculta también el campo de búsqueda
        }
      });

      // Cada vez que el usuario escribe en el campo de búsqueda
      $('#busqueda').keyup(function() {
        filtrarLibros(); // Filtra los libros en tiempo real
      });

      // Al hacer clic en el botón "Cancelar reserva", se oculta el formulario
      $('#cancelar-reserva').click(function() {
        $('#formulario-reserva').hide();
      });

      // Al enviar el formulario de reserva
      $('#reserva-form').submit(function(e) {
        e.preventDefault();  // Evita que el formulario se envíe de forma tradicional
        enviarReserva();     // Envía los datos por AJAX
      });

      // Función que carga los libros desde el backend usando AJAX
      function cargarLibros(categoria) {
        $.ajax({
          url: '/api/cargarLibrosPorCategoria',
          type: 'GET',
          data: { categoria: categoria },
          beforeSend: function() {
            $('#lista-libros').html('<div class="cargando">Cargando libros...</div>'); // Muestra mensaje de carga
          },
          success: function(data) {
            todosLosLibros = data;      // Guarda todos los libros
            librosFiltrados = data;     // Inicialmente, los filtrados son todos
            mostrarLibros(data);        // Muestra los libros en pantalla
            $('#categoria-seleccionada').val(categoria); // Guarda la categoría en un campo oculto
            $('#resultados-container').show();           // Muestra el contenedor de resultados
          },
          error: function() {
            mostrarMensajeReserva('Error al cargar los libros', true); // Muestra error si falla la petición
          }
        });
      }

      // Función que filtra los libros según el texto ingresado por el usuario
      function filtrarLibros() {
        const busqueda = $('#busqueda').val().toLowerCase();

        if (busqueda === '') {
          librosFiltrados = todosLosLibros;
        } else {
          librosFiltrados = todosLosLibros.filter(function(libro) {
            return libro.titulo.toLowerCase().includes(busqueda) ||
                   (libro.autor && libro.autor.toLowerCase().includes(busqueda));
          });
        }

        mostrarLibros(librosFiltrados); // Muestra los libros filtrados
      }

      // Función que muestra los libros en pantalla
      function mostrarLibros(libros) {
        const $lista = $('#lista-libros');
        $lista.empty(); // Limpia el contenedor

        if (libros.length === 0) {
          $lista.html('<div class="sin-resultados">No se encontraron libros</div>');
          $('#contador').text('0 libros encontrados');
          return;
        }

        $('#contador').text(libros.length + ' libros encontrados');

        // Recorre la lista de libros y crea una "tarjeta" por cada uno
        libros.forEach(function(libro) {
          $lista.append(`
            <div class="libro-item" data-titulo="${libro.titulo}">
              <h3>${libro.titulo}</h3>
              ${libro.autor ? `<p><strong>Autor:</strong> ${libro.autor}</p>` : ''}
              ${libro.anioPublicacion ? `<p><strong>Año:</strong> ${libro.anioPublicacion}</p>` : ''}
              <button class="btn-seleccionar">Seleccionar</button>
            </div>
          `);
        });

        // Asigna la función al botón de "Seleccionar"
        $('.btn-seleccionar').click(function() {
          const titulo = $(this).closest('.libro-item').data('titulo');
          $('#libro-seleccionado').val(titulo);  // Llena el campo oculto con el título
          $('#formulario-reserva').show();       // Muestra el formulario
          // Desplaza la página hacia el formulario
          $('html, body').animate({
            scrollTop: $('#formulario-reserva').offset().top
          }, 500);
        });
      }

      // Envía el formulario de reserva al backend usando AJAX
      function enviarReserva() {
        const formData = $('#reserva-form').serialize(); // Serializa los datos del formulario

        $.ajax({
          url: '/api/guardarReservaUsuario',
          type: 'POST',
          data: formData,
          success: function(response) {
            $('#reserva-form')[0].reset();      // Limpia el formulario
            $('#formulario-reserva').hide();    // Oculta el formulario
            mostrarMensajeReserva('Reserva realizada con éxito'); // Muestra mensaje de éxito
          },
          error: function() {
            mostrarMensajeReserva('Error al realizar la reserva', true); // Muestra error
          }
        });
      }

      // Muestra un mensaje en pantalla (éxito o error)
      function mostrarMensajeReserva(mensaje, esError = false) {
        const $mensaje = $('#mensaje-reserva');
        $mensaje.text(mensaje);
        $mensaje.css('background-color', esError ? '#e74c3c' : '#4CAF50'); // Rojo si es error, verde si es éxito
        $mensaje.fadeIn(300).delay(3000).fadeOut(500); // Muestra el mensaje por 3 segundos
      }

    });
</script>

</body>
</html>
